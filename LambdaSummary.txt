================================================================================
File Path: /Users/mehemmedyusifov/Desktop/npp-web-proto/lambda/BayesianStarterLambda.ts
--------------------------------------------------------------------------------

import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';
import { parseRequestBody } from './utils-bayesian/parser';
import { validateFormData } from './utils-bayesian/validate';
import { ECSClient, RunTaskCommand } from "@aws-sdk/client-ecs";
import { DynamoDBClient } from "@aws-sdk/client-dynamodb";
import { DynamoDBDocumentClient, PutCommand } from "@aws-sdk/lib-dynamodb";
import { randomUUID } from "crypto";

const ecsClient = new ECSClient({});
const docClient = DynamoDBDocumentClient.from(new DynamoDBClient({}));

const TABLE_NAME = process.env.JOBS_TABLE_NAME;
const CLUSTER_NAME = process.env.CLUSTER_NAME;
const TASK_DEFINITION = process.env.TASK_DEFINITION;
const SUBNET_ID = process.env.SUBNET_ID;
const CONTAINER_NAME = process.env.CONTAINER_NAME;

export const handler = async (event: APIGatewayProxyEvent): Promise<APIGatewayProxyResult> => {
  console.log("Received request to start simulation job.");

  if (!TABLE_NAME || !CLUSTER_NAME || !TASK_DEFINITION || !SUBNET_ID || !CONTAINER_NAME) {
    console.error("Missing required environment variables.");
    return {
      statusCode: 500,
      headers: { "Access-Control-Allow-Origin": "*" },
      body: JSON.stringify({ message: "Internal server error: Service is not configured correctly." }),
    };
  }

  const { success, data: nestedData, error: parsingError } = parseRequestBody(event);

  if (!success || !nestedData) {
    return {
      statusCode: 400,
      headers: { "Access-Control-Allow-Origin": "*" },
      body: JSON.stringify({ message: parsingError }),
    };
  }

  // --- FLATTEN THE DATA STRUCTURE ---
  // Extract settings and combine with the rest of the form data.
  const { settings, ...tabData } = nestedData;
  const flatFormData: Record<string, any> = { ...settings };

  // The tab data is nested one level deeper, so we need to flatten it.
  for (const key in tabData) {
      Object.assign(flatFormData, tabData[key]);
  }

  const { isValid, errors } = validateFormData(flatFormData);

  if (!isValid) {
    console.error("Validation failed:", errors);
    return {
      statusCode: 400,
      headers: { "Access-Control-Allow-Origin": "*" },
      body: JSON.stringify({ message: "Invalid form data submitted.", errors }),
    };
  }

  console.log("Validation successful. Proceeding to start Fargate task...");

  try {
    const jobId = randomUUID();
    console.log(`Starting job with ID: ${jobId}`);

    const dbItem = {
      jobId,
      jobStatus: "PENDING",
      formData: flatFormData,
      createdAt: new Date().toISOString(),
    };
    await docClient.send(new PutCommand({ TableName: TABLE_NAME, Item: dbItem }));

    const formDataEnvironmentVariables = Object.entries(flatFormData).map(([key, value]) => ({
      name: key,
      value: String(value),
    }));

    const command = new RunTaskCommand({
      cluster: CLUSTER_NAME,
      taskDefinition: TASK_DEFINITION,
      launchType: "FARGATE",
      networkConfiguration: {
        awsvpcConfiguration: { subnets: [SUBNET_ID], assignPublicIp: "ENABLED" },
      },
      overrides: {
        containerOverrides: [{
          name: CONTAINER_NAME,
          environment: [{ name: "JOB_ID", value: jobId }, ...formDataEnvironmentVariables],
        }],
      },
    });

    await ecsClient.send(command);
    console.log(`Fargate task started successfully for job ${jobId}.`);

    return {
      statusCode: 202,
      headers: { "Access-Control-Allow-Origin": "*" },
      body: JSON.stringify({ message: "Job accepted for processing.", jobId }),
    };
  } catch (error) {
    console.error("Error activating Fargate task:", error);
    return {
      statusCode: 500,
      headers: { "Access-Control-Allow-Origin": "*" },
      body: JSON.stringify({ message: "Internal server error: Could not start the simulation job." }),
    };
  }
};

================================================================================

================================================================================
File Path: /Users/mehemmedyusifov/Desktop/npp-web-proto/lambda/utils-bayesian/validate.ts
--------------------------------------------------------------------------------

// --- /utils-bayesian/validate.ts ---

import { validationSchema } from './tabs';

// Define a type for the function's return value for clarity
interface ValidationResult {
  isValid: boolean;
  errors: string[];
}

// The formData is expected to be a flat JSON object with string keys and any value type from the form.
export function validateFormData(formData: Record<string, any>): ValidationResult {
  console.log("Received request for validation.");
  const errors: string[] = [];

  // Define the settings fields that should be allowed but not validated against the schema.
  const settingsFields = new Set<string>([
      "nChains", 
      "nIter", 
      "nBurnin", 
      "nThin",
      "autoCloseWinBugs",
      "computeDIC", 
      "workingDir"
  ]);

  if (typeof formData !== 'object' || formData === null) {
    return { isValid: false, errors: ["Request body must be a valid JSON object."] };
  }

  for (const fieldLabel in formData) {
    const submittedValue = formData[fieldLabel];

    // If the current field is a known setting, skip the rest of the validation.
    if (settingsFields.has(fieldLabel)) {
      continue;
    }

    // 1. Check if the submitted field is a known, valid field from the TABS schema.
    if (!validationSchema.has(fieldLabel)) {
      errors.push(`Field '${fieldLabel}' is not a valid field.`);
      continue;
    }

    const allowedValues = validationSchema.get(fieldLabel);

    // 2. Handle the special case for "FP Input".
    if (fieldLabel === "FP Input") {
      if (typeof submittedValue !== 'string' || submittedValue.trim() === '') {
        errors.push("Field 'FP Input' must be a non-empty string.");
      }
      continue;
    }

    // 3. For all other fields, check if the submitted value is in the allowed list.
    // The '!' tells TypeScript that we are sure 'allowedValues' is not undefined here
    // because we already checked with validationSchema.has().
    if (!allowedValues!.includes(submittedValue)) {
      errors.push(`Invalid value for '${fieldLabel}'. Received '${submittedValue}', but expected one of: ${allowedValues!.join(', ')}.`);
    }
  }

  return {
    isValid: errors.length === 0,
    errors: errors,
  };
}


================================================================================

================================================================================
File Path: /Users/mehemmedyusifov/Desktop/npp-web-proto/lambda/utils-bayesian/parser.ts
--------------------------------------------------------------------------------

import { APIGatewayProxyEvent } from 'aws-lambda';

interface ParseResult {
  success: boolean;
  data: any | null;
  error: string | null;
}

export function parseRequestBody(event: APIGatewayProxyEvent): ParseResult {
  try {
    if (!event.body) {
      return { success: false, data: null, error: "Request body is empty." };
    }

    // First parse: gets the outer object, e.g., { data: "..." }
    const outerObject = JSON.parse(event.body);

    if (typeof outerObject.data !== 'string') {
      return { success: false, data: null, error: "Request body must contain a 'data' key with a stringified JSON object." };
    }

    // Second parse: gets the actual form data from the inner string
    const innerData = JSON.parse(outerObject.data);
    
    return { success: true, data: innerData, error: null };

  } catch (error) {
    console.error("JSON Parsing Error:", error);
    return { success: false, data: null, error: "Invalid JSON format in request body." };
  }
}

================================================================================

================================================================================
File Path: /Users/mehemmedyusifov/Desktop/npp-web-proto/lambda/utils-bayesian/tabs.ts
--------------------------------------------------------------------------------

// This block contains two files that you would package together in a .zip file for deployment.

// --- /validation/schema.js ---
// This file acts as the single source of truth for our validation rules.
// It's directly derived from your TABS.ts constant.

const TABS = [
  {
    label: "FP",
    children: [{ label: "FP Input", values: [""] }],
  },
  {
    label: "Requirement Dev",
    children: [
      {
        label: "Software Development Planning",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Development of Concept",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Development of SRS",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Traceability Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Criticality Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Hazard Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Security Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Risk Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Sofware Quanlification",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Software Acceptance",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Configuration Management",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Review and Audit",
        values: ["Low", "Medium", "High"],
      },
    ],
  },
  {
    label: "Requirement V&V",
    children: [
      {
        label: "Software Planning",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Concpet Documentation Evaluation",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Sofware User Requirement Allocation Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Sofware Requirement Evaluation",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Interface Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Traceability Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Criticality Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Hazard Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Security Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Risk Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Sofware Quanlification",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Software Acceptance",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Configuration Management",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Review and Audit",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Acitivity Summary Report",
        values: ["Low", "Medium", "High"],
      },
    ],
  },
  {
    label: "Design Dev",
    children: [
      {
        label: "Development Sofware Architecture",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Development Sofware Design",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Traceability Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Criticality Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Hazard Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Security Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Risk Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Sofware Component Test Plan",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Integration Test Plan",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Component Test Design",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Integration Test Design",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Software Quanlification",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Software Acceptance",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Configuration Management",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Review and Audit",
        values: ["Low", "Medium", "High"],
      },
    ],
  },
  {
    label: "Design V&V",
    children: [
      {
        label: "Design Evaluation",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Interface Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Traceability Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Criticality Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Hazard Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Security Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Risk Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Component Test Plan",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Integration Test Plan",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Component Test Design",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Integration Test Design",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Sofware Quanlification",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Software Acceptance",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Configuration Management",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Review and Audit",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Acitivity Summary Report",
        values: ["Low", "Medium", "High"],
      },
    ],
  },
  {
    label: "Implementation Dev",
    children: [
      {
        label: "Source Code Document",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Traceability Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Criticality Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Hazard Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Security Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Risk Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Sofware Component Test Case",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Integration Test Case",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Sofware Acceptance Test Case",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Component Test Procedure",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Integration Test Procedure",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Software Quanlification",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Software Component Test Execution",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Configuration Management",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Review and Audit",
        values: ["Low", "Medium", "High"],
      },
    ],
  },
  {
    label: "Implementation V&V",
    children: [
      {
        label: "Source Code Document",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Interface Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Traceability Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Criticality Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Hazard Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Security Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Risk Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Sofware Component Test Case",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Integration Test Case",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Qualification Test Case",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Sofware Acceptance Test Case",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Component Test Procedure",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Software Integration Test Procedure",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Software Quanlification Test Procedure",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Software Component Test Execution",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Configuration Management",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Review and Audit",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Acitivity Summary Report",
        values: ["Low", "Medium", "High"],
      },
    ],
  },
  {
    label: "Test Dev",
    children: [
      {
        label: "Traceability Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Hazard Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Security Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Risk Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Software Acceptance Test Execution",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Sofware Acceptance Procedure Generation",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Sofware Integration Test Execution",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Sofware Quanlification Test Execution",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Configuration Management",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Review and Audit",
        values: ["Low", "Medium", "High"],
      },
    ],
  },
  {
    label: "Test V&V",
    children: [
      {
        label: "Traceability Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Hazard Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Security Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Risk Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Software Acceptance Test Execution",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Sofware Acceptance Procedure Generation",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Sofware Integration Test Execution",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "System Sofware Quanlification Test Execution",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Configuration Management",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Review and Audit",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Acitivity Summary Report",
        values: ["Low", "Medium", "High"],
      },
    ],
  },
  {
    label: "Installlation and Checkout Dev",
    children: [
      {
        label: "Installation Procedure Generation",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Installation and Checkout",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Hazard Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Security Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Risk Analysis",
        values: ["Low", "Medium", "High"],
      },
    ],
  },
  {
    label: "Installlation and Checkout V&V",
    children: [
      {
        label: "Installation Procedure Generation",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Installation and Checkout",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Hazard Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Security Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Risk Analysis",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Acitivity Summary Report",
        values: ["Low", "Medium", "High"],
      },
      {
        label: "Final Report Generation",
        values: ["Low", "Medium", "High"],
      },
    ],
  },
] as const;


// To make lookups faster, we transform the array into a Map object.
// The key will be the field label (e.g., "Software Development Planning")
// and the value will be the array of its allowed values (e.g., ["Low", "Medium", "High"]).
const validationSchema = new Map();

TABS.forEach(tab => {
  tab.children.forEach(child => {
    validationSchema.set(child.label, child.values);
  });
});

// We export the schema so our handler can use it.
export { validationSchema };

================================================================================

